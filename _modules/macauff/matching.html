
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>macauff.matching &#8212; macauff</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pyramid.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.matching</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for macauff.matching</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module provides the high-level framework for performing catalogue-catalogue cross-matches.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.perturbation_auf</span> <span class="kn">import</span> <span class="n">make_perturb_aufs</span>
<span class="kn">from</span> <span class="nn">.group_sources</span> <span class="kn">import</span> <span class="n">make_island_groupings</span>
<span class="kn">from</span> <span class="nn">.group_sources_fortran</span> <span class="kn">import</span> <span class="n">group_sources_fortran</span> <span class="k">as</span> <span class="n">gsf</span>
<span class="kn">from</span> <span class="nn">.misc_functions_fortran</span> <span class="kn">import</span> <span class="n">misc_functions_fortran</span> <span class="k">as</span> <span class="n">mff</span>
<span class="kn">from</span> <span class="nn">.photometric_likelihood</span> <span class="kn">import</span> <span class="n">compute_photometric_likelihoods</span>
<span class="kn">from</span> <span class="nn">.counterpart_pairing</span> <span class="kn">import</span> <span class="n">source_pairing</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CrossMatch&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="CrossMatch"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch">[docs]</a><span class="k">class</span> <span class="nc">CrossMatch</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to cross-match two photometric catalogues with one another, producing</span>
<span class="sd">    a composite catalogue of merged sources.</span>

<span class="sd">    The class takes three paths, the locations of the metadata files containing</span>
<span class="sd">    all of the necessary parameters for the cross-match, and outputs a file</span>
<span class="sd">    containing the appropriate columns of the datasets plus additional derived</span>
<span class="sd">    parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    joint_file_path : string</span>
<span class="sd">        A path to the location of the file containing the cross-match metadata.</span>
<span class="sd">    cat_a_file_path : string</span>
<span class="sd">        A path to the location of the file containing the catalogue &quot;a&quot; specific</span>
<span class="sd">        metadata.</span>
<span class="sd">    cat_b_file_path : string</span>
<span class="sd">        A path to the location of the file containing the catalogue &quot;b&quot; specific</span>
<span class="sd">        metadata.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialisation function for cross-match class.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Input parameter file </span><span class="si">{}</span><span class="s2"> could not be found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joint_file_path</span> <span class="o">=</span> <span class="n">joint_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_a_file_path</span> <span class="o">=</span> <span class="n">cat_a_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_b_file_path</span> <span class="o">=</span> <span class="n">cat_b_file_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_metadata</span><span class="p">()</span>

        <span class="c1"># Important steps that can be save points in the match process are:</span>
        <span class="c1"># AUF creation, island splitting, c/f creation, star pairing. We have</span>
        <span class="c1"># to check if any later stages are flagged to not run (i.e., they are</span>
        <span class="c1"># the starting point) than earlier stages, and raise an error.</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">run_auf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_cf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_source</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistency between run/no run flags; please ensure that &quot;</span>
                                 <span class="s2">&quot;if a sub-process is set to run that all subsequent &quot;</span>
                                 <span class="s2">&quot;processes are also set to run.&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure that we can create the folders for outputs.</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="s1">&#39;phot_like&#39;</span><span class="p">,</span> <span class="s1">&#39;pairing&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Error when trying to create temporary folder for joint outputs. &quot;</span>
                              <span class="s2">&quot;Please ensure that joint_folder_path is correct.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">],</span>
                                       <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Error when trying to create temporary folder for catalogue </span><span class="si">{}</span><span class="s2"> AUF &quot;</span>
                              <span class="s2">&quot;outputs. Please ensure that </span><span class="si">{}</span><span class="s2">auf_folder_path is correct.&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>

        <span class="c1"># Unlike the AUF folder paths, which are allowed to not exist at</span>
        <span class="c1"># runtime, we simply check that cat_folder_path exists for both</span>
        <span class="c1"># input catalogues, with three appropriately shaped arrays in it,</span>
        <span class="c1"># and error if not.</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">],</span>
                                       <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_folder_path does not exist. Please ensure that &#39;</span>
                              <span class="s1">&#39;path for catalogue </span><span class="si">{}</span><span class="s1"> is correct.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Currently forcing hard-coded three-part numpy array names,</span>
                <span class="c1"># to come out of &quot;skinny table&quot; consolidated catalogue</span>
                <span class="c1"># generation.</span>
                <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;con_cat_astro&#39;</span><span class="p">,</span> <span class="s1">&#39;con_cat_photo&#39;</span><span class="p">,</span> <span class="s1">&#39;magref&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> file not found in catalogue </span><span class="si">{}</span><span class="s1"> path. &#39;</span>
                                                <span class="s1">&#39;Please run catalogue consolidation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">file_name</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                <span class="c1"># Shape, mapped to each of astro/photo/magref respectively,</span>
                <span class="c1"># should map to 3, number of magnitudes, and 1, where magref is</span>
                <span class="c1"># a 1-D array but the other two are 2-D.</span>
                <span class="n">fn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_astro.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">fn_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_photo.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">fn_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/magref.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_m</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incorrect number of dimensions in consolidated &quot;</span>
                                     <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> files.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Second dimension of con_cat_astro in catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;should be 3.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Second dimension of con_cat_photo in catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;should be the same as the number of filters listed &quot;</span>
                                     <span class="s2">&quot;in </span><span class="si">{}</span><span class="s2">filt_names.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">fn_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Consolidated catalogue arrays for catalogue </span><span class="si">{}</span><span class="s2"> should &quot;</span>
                                     <span class="s2">&quot;all be consistent lengths.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Error when trying to create temporary folder for catalogue-level &quot;</span>
                              <span class="s2">&quot;outputs. Please ensure that catalogue folder names are correct.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tri_flag</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a_download_tri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_download_tri</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">tri_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_auf</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">download_tri is True and run_auf is False. Please ensure &quot;</span>
                                     <span class="s2">&quot;that run_auf is True if new TRILEGAL simulations are to be &quot;</span>
                                     <span class="s2">&quot;downloaded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_shared_data</span><span class="p">()</span>

<div class="viewcode-block" id="CrossMatch.__call__"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Call function for CrossMatch, to run the various stages of cross-matching</span>
<span class="sd">        two photometric catalogues.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># The first step is to create the perturbation AUF components, if needed.</span>
        <span class="c1"># If run_auf is set to True or if there are not the appropriate number of</span>
        <span class="c1"># pre-saved outputs from a previous run then run perturbation AUF creation.</span>
        <span class="c1"># TODO: generalise the number of files per AUF simulation as input arg.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_perturb_auf</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

        <span class="c1"># Once AUF components are assembled, we now group sources based on</span>
        <span class="c1"># convolved AUF integration lengths, to get &quot;common overlap&quot; sources</span>
        <span class="c1"># and merge such overlaps into distinct &quot;islands&quot; of sources to match.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sources</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

        <span class="c1"># The third step in this process is to, to some level, calculate the</span>
        <span class="c1"># photometry-related information necessary for the cross-match.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_phot_like</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># The final stage of the cross-match process is that of putting together</span>
        <span class="c1"># the previous stages, and calculating the cross-match probabilities.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_sources</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_str2bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convenience function to convert strings to boolean values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : string</span>
<span class="sd">            String entry to be converted to ``True`` or ``False``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        flag_val : boolean</span>
<span class="sd">            Boolean-converted value that ``v`` represents.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Boolean flag key not set to allowed value.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag_val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flag_val</span>

    <span class="k">def</span> <span class="nf">_make_regions_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_type</span><span class="p">,</span> <span class="n">region_frame</span><span class="p">,</span> <span class="n">region_points</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wrapper function for the creation of &quot;region&quot; coordinate tuples,</span>
<span class="sd">        given either a set of rectangular points or a list of coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region_type : string</span>
<span class="sd">            String containing the kind of system the region pointings are in.</span>
<span class="sd">            Should be &quot;rectangle&quot;, regularly sampled points in the two sky</span>
<span class="sd">            coordinates, or &quot;points&quot;, individually specified sky coordinates.</span>
<span class="sd">        region_Frame : string</span>
<span class="sd">            String containing the coordinate system the points are in. Should</span>
<span class="sd">            be either &quot;equatorial&quot; or &quot;galactic&quot;.</span>
<span class="sd">        region_points : string</span>
<span class="sd">            String containing the evaluation points. If ``region_type`` is</span>
<span class="sd">            &quot;rectangle&quot;, should be six values, the start and stop values and</span>
<span class="sd">            number of entries of the respective sky coordinates; and if</span>
<span class="sd">            ``region_type`` is &quot;points&quot;, ``region_points`` should be tuples</span>
<span class="sd">            of the form ``(a, b)`` separated by whitespace.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">region_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">region_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be 6 numbers separated &quot;</span>
                                 <span class="s2">&quot;by spaces.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of steps between start and stop values for &quot;</span>
                                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be integers.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">ax1_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">ax2_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ax1_p</span><span class="p">,</span> <span class="n">ax2_p</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be 6 numbers separated &quot;</span>
                                 <span class="s2">&quot;by spaces.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;points&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">region_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;), )&#39;</span><span class="p">)</span>
                <span class="c1"># Remove the first ( and final ) that weren&#39;t split by &quot;), (&quot; -&gt; &quot;), )&quot;</span>
                <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be a list of &#39;(a, b), (c, d)&#39; tuples, &quot;</span>
                                 <span class="s2">&quot;separated by a comma.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should either be &#39;rectangle&#39; or &#39;points&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">)</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="n">region_frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rf</span> <span class="o">==</span> <span class="s1">&#39;equatorial&#39;</span> <span class="ow">or</span> <span class="n">rf</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">region_frame</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should either be &#39;equatorial&#39; or &#39;galactic&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">region_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<div class="viewcode-block" id="CrossMatch.read_metadata"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.read_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">read_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper function to read in metadata and set various class attributes.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">joint_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">joint_config</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="s1">&#39;[config]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">joint_config</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="n">cat_a_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_a_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cat_a_config</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="s1">&#39;[config]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">cat_a_config</span> <span class="o">=</span> <span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="n">cat_b_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_b_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cat_b_config</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="s1">&#39;[config]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">cat_b_config</span> <span class="o">=</span> <span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;include_perturb_auf&#39;</span><span class="p">,</span> <span class="s1">&#39;include_phot_like&#39;</span><span class="p">,</span> <span class="s1">&#39;run_auf&#39;</span><span class="p">,</span> <span class="s1">&#39;run_group&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;run_cf&#39;</span><span class="p">,</span> <span class="s1">&#39;run_source&#39;</span><span class="p">,</span> <span class="s1">&#39;cf_region_type&#39;</span><span class="p">,</span> <span class="s1">&#39;cf_region_frame&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;cf_region_points&#39;</span><span class="p">,</span> <span class="s1">&#39;joint_folder_path&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_corr_dist&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;real_hankel_points&#39;</span><span class="p">,</span> <span class="s1">&#39;four_hankel_points&#39;</span><span class="p">,</span> <span class="s1">&#39;four_max_rho&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;cross_match_extent&#39;</span><span class="p">,</span> <span class="s1">&#39;mem_chunk_num&#39;</span><span class="p">,</span> <span class="s1">&#39;int_fracs&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joint_config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from joint metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auf_region_type&#39;</span><span class="p">,</span> <span class="s1">&#39;auf_region_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;auf_region_points&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;filt_names&#39;</span><span class="p">,</span> <span class="s1">&#39;cat_name&#39;</span><span class="p">,</span> <span class="s1">&#39;dens_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;auf_folder_path&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;cat_folder_path&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">run_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;include_perturb_auf&#39;</span><span class="p">,</span> <span class="s1">&#39;include_phot_like&#39;</span><span class="p">,</span> <span class="s1">&#39;run_auf&#39;</span><span class="p">,</span> <span class="s1">&#39;run_group&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;run_cf&#39;</span><span class="p">,</span> <span class="s1">&#39;run_source&#39;</span><span class="p">,</span> <span class="s1">&#39;use_phot_priors&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_flag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="n">run_flag</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_regions_points</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">auf_region_type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auf_region_type&#39;</span><span class="p">]],</span>
                                      <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">auf_region_frame&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auf_region_frame&#39;</span><span class="p">]],</span>
                                      <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">auf_region_points&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auf_region_points&#39;</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_make_regions_points</span><span class="p">([</span><span class="s1">&#39;cf_region_type&#39;</span><span class="p">,</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cf_region_type&#39;</span><span class="p">]],</span>
                                  <span class="p">[</span><span class="s1">&#39;cf_region_frame&#39;</span><span class="p">,</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cf_region_frame&#39;</span><span class="p">]],</span>
                                  <span class="p">[</span><span class="s1">&#39;cf_region_points&#39;</span><span class="p">,</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cf_region_points&#39;</span><span class="p">]])</span>

        <span class="c1"># If the frame of the two AUF parameter files and the &#39;cf&#39; frame are</span>
        <span class="c1"># not all the same then we have to raise an error.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_frame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region frames for c/f and AUF creation must all be the same.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;joint_folder_path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;auf_folder_path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;auf_folder_path&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;cat_folder_path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;cat_folder_path&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="c1"># Only have to check for the existence of Pertubation AUF-related</span>
        <span class="c1"># parameters if we are using the perturbation AUF component.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tri_set_name&#39;</span><span class="p">,</span> <span class="s1">&#39;tri_filt_names&#39;</span><span class="p">,</span> <span class="s1">&#39;psf_fwhms&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;download_tri&#39;</span><span class="p">,</span> <span class="s1">&#39;dens_mags&#39;</span><span class="p">,</span> <span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;num_trials&#39;</span><span class="p">,</span> <span class="s1">&#39;dm_max&#39;</span><span class="p">,</span> <span class="s1">&#39;d_mag&#39;</span><span class="p">,</span> <span class="s1">&#39;compute_local_density&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joint_config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from joint metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_download_tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;download_tri&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_download_tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;download_tri&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_set_name</span> <span class="o">=</span> <span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;tri_set_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_set_name</span> <span class="o">=</span> <span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;tri_set_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_filt_names and </span><span class="si">{}</span><span class="s1">filt_names should contain the &#39;</span>
                                     <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>

            <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span>
                                             <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_filt_num&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_filt_num&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tri_filt_num should be a single integer number in &quot;</span>
                                         <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tri_filt_num should be a single integer number in &quot;</span>
                                     <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

            <span class="c1"># These parameters are also only used if we are using the</span>
            <span class="c1"># Perturbation AUF component.</span>
            <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span>
                                             <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dens_mags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dens_mags should be a list of floats in &#39;</span>
                                     <span class="s1">&#39;catalogue </span><span class="si">{}</span><span class="s1"> metadata file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">dens_mags and </span><span class="si">{}</span><span class="s1">filt_names should contain the &#39;</span>
                                     <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">dens_mags&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;num_trials&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_trials should be an integer.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_trials should be an integer.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dm_max&#39;</span><span class="p">,</span> <span class="s1">&#39;d_mag&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="n">flag</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must be a float.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">compute_local_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;compute_local_density&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_local_density</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span>
                                                 <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">dens_dist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dens_dist&#39;</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dens_dist in catalogue </span><span class="si">{}</span><span class="s2"> must be a float.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">fit_gal_flag</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">fit_gal_flag</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gal_wavs&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_zmax&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_nzs&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;gal_aboffsets&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_filternames&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_al_avs&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span>
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                    <span class="c1"># Set all lists of floats</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gal_wavs&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_zmax&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_aboffsets&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_al_avs&#39;</span><span class="p">]:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> should be a list of floats in catalogue &#39;</span>
                                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">filt_names should contain the same &#39;</span>
                                             <span class="s1">&#39;number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>
                    <span class="c1"># galaxy_nzs should be a list of integers.</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gal_nzs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;gal_nzs should be a list of integers &#39;</span>
                                         <span class="s1">&#39;in catalogue </span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_nzs and </span><span class="si">{}</span><span class="s1">filt_names should contain the same &#39;</span>
                                         <span class="s1">&#39;number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All elements of </span><span class="si">{}</span><span class="s1">gal_nzs should be &#39;</span>
                                         <span class="s1">&#39;integers.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_nzs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>
                    <span class="c1"># Filter names are simple lists of strings</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gal_filternames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_filternames and </span><span class="si">{}</span><span class="s1">filt_names should contain the &#39;</span>
                                         <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_filternames&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span>
                                         <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;psf_fwhms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;psf_fwhms should be a list of floats in catalogue </span><span class="si">{}</span><span class="s1"> metadata &#39;</span>
                                 <span class="s1">&#39;file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">psf_fwhms and </span><span class="si">{}</span><span class="s1">filt_names should contain the &#39;</span>
                                 <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">psf_fwhms&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span> <span class="o">=</span> <span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;cat_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span> <span class="o">=</span> <span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;cat_name&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_corr_dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;pos_corr_dist&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pos_corr_dist must be a float.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;real_hankel_points&#39;</span><span class="p">,</span> <span class="s1">&#39;four_hankel_points&#39;</span><span class="p">,</span> <span class="s1">&#39;four_max_rho&#39;</span><span class="p">]:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be an integer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be an integer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cross_match_extent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All elements of cross_match_extent should be floats.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cross_match_extent should contain four elements.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span> <span class="o">=</span> <span class="n">b</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;mem_chunk_num&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mem_chunk_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mem_chunk_num should be a single integer number.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mem_chunk_num should be a single integer number.&quot;</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;int_fracs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All elements of int_fracs should be floats.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;int_fracs should contain three elements.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span> <span class="o">=</span> <span class="n">b</span></div>

<div class="viewcode-block" id="CrossMatch.make_shared_data"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.make_shared_data">[docs]</a>    <span class="k">def</span> <span class="nf">make_shared_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to initialise the shared variables used in the cross-match process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_corr_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_hankel_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_max_rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_hankel_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>
        <span class="c1"># Only need to calculate these the first time we need them, so buffer for now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CrossMatch.create_perturb_auf"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.create_perturb_auf">[docs]</a>    <span class="k">def</span> <span class="nf">create_perturb_auf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_per_auf_sim</span><span class="p">,</span> <span class="n">perturb_auf_func</span><span class="o">=</span><span class="n">make_perturb_aufs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function wrapping the main perturbation AUF component creation routines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files_per_auf_sim : integer</span>
<span class="sd">            The number of output files for each individual perturbation simulation.</span>
<span class="sd">        perturb_auf_func : callable, optional</span>
<span class="sd">            ``perturb_auf_func`` should create the perturbation AUF output files</span>
<span class="sd">            for each filter-pointing combination.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Each catalogue has in its auf_folder_path a single file, a local</span>
        <span class="c1"># normalising density, plus -- per AUF &quot;pointing&quot; -- a simulation file</span>
        <span class="c1"># and N simulation files per filter. Additionally, it will contain a</span>
        <span class="c1"># single file with each source&#39;s index reference into the cube of AUFs,</span>
        <span class="c1"># and a convenience cube for each N-m combination array&#39;s length; it will</span>
        <span class="c1"># also contain 3- and 4-D cubes of the fourier-space perturbation AUF</span>
        <span class="c1"># component, and simulated flux contamination and fraction of contaminated</span>
        <span class="c1"># sources, for all simulations.</span>
        <span class="n">a_expected_files</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">files_per_auf_sim</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">))</span>
        <span class="n">a_file_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">)])</span>
        <span class="n">a_correct_file_number</span> <span class="o">=</span> <span class="n">a_expected_files</span> <span class="o">==</span> <span class="n">a_file_number</span>

        <span class="c1"># Magnitude offsets corresponding to relative fluxes of perturbing sources; here</span>
        <span class="c1"># dm of 2.5 is 10% relative flux and dm = 5 corresponds to 1% relative flux. Used</span>
        <span class="c1"># to inform the fraction of simulations with a contaminant above these relative</span>
        <span class="c1"># fluxes.</span>
        <span class="c1"># TODO: allow as user input.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

        <span class="c1"># TODO: allow as user input.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="c1"># See Wilson (2022, RNAAS, 6, 60) for the meanings of the variables c, m,</span>
        <span class="c1"># a, and u. For each of M*/phi*/alpha/P/Q, for blue+red galaxies, 2-4</span>
        <span class="c1"># variables are derived as a function of wavelength, or Q(P).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">24.286513</span><span class="p">,</span> <span class="mf">1.141760</span><span class="p">,</span> <span class="mf">2.655846</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">23.192520</span><span class="p">,</span> <span class="mf">1.778718</span><span class="p">,</span> <span class="mf">1.668292</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.001487</span><span class="p">,</span> <span class="mf">2.918841</span><span class="p">,</span> <span class="mf">0.000510</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="mf">0.000560</span><span class="p">,</span> <span class="mf">7.691261</span><span class="p">,</span> <span class="mf">0.003330</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.065565</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">1.257761</span><span class="p">,</span> <span class="mf">0.021362</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">0.309077</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.067411</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.302018</span><span class="p">,</span> <span class="mf">0.034203</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">0.713062</span><span class="p">,</span> <span class="mf">0.233366</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.233627</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.322347</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="mf">1.068926</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.385984</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.079</span><span class="p">,</span> <span class="mf">3.524</span><span class="p">,</span> <span class="mf">1.917</span><span class="p">,</span> <span class="mf">1.992</span><span class="p">,</span> <span class="mf">2.536</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.461</span><span class="p">,</span> <span class="mf">2.358</span><span class="p">,</span> <span class="mf">2.568</span><span class="p">,</span> <span class="mf">2.268</span><span class="p">,</span> <span class="mf">2.402</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.265</span><span class="p">,</span> <span class="mf">3.862</span><span class="p">,</span> <span class="mf">1.921</span><span class="p">,</span> <span class="mf">1.685</span><span class="p">,</span> <span class="mf">2.480</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.410</span><span class="p">,</span> <span class="mf">2.340</span><span class="p">,</span> <span class="mf">2.200</span><span class="p">,</span> <span class="mf">2.540</span><span class="p">,</span> <span class="mf">2.464</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">3.47e+09</span><span class="p">,</span> <span class="mf">3.31e+06</span><span class="p">,</span> <span class="mf">2.13e+09</span><span class="p">,</span> <span class="mf">1.64e+10</span><span class="p">,</span> <span class="mf">1.01e+09</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">3.84e+09</span><span class="p">,</span> <span class="mf">1.57e+06</span><span class="p">,</span> <span class="mf">3.91e+08</span><span class="p">,</span> <span class="mf">4.66e+10</span><span class="p">,</span> <span class="mf">3.03e+07</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_auf</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">a_correct_file_number</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">calc_j0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Only warn if we did NOT choose to run AUF, but DID hit wrong file</span>
            <span class="c1"># number.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a_correct_file_number</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_auf</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Incorrect number of files in catalogue &quot;a&quot; perturbation &#39;</span>
                              <span class="s1">&#39;AUF simulation folder. Deleting all files and re-running &#39;</span>
                              <span class="s1">&#39;cross-match process.&#39;</span><span class="p">)</span>
                <span class="c1"># Once run AUF flag is updated, all other flags need to be set to run</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_cf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_source</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;psf_fwhms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_psf_fwhms</span><span class="p">,</span> <span class="s1">&#39;tri_download_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_download_tri</span><span class="p">,</span>
                           <span class="s1">&#39;delta_mag_cuts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span><span class="p">,</span> <span class="s1">&#39;num_trials&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">,</span>
                           <span class="s1">&#39;j0s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="p">,</span> <span class="s1">&#39;density_mags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dens_mags</span><span class="p">,</span>
                           <span class="s1">&#39;dm_max&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_max</span><span class="p">,</span> <span class="s1">&#39;d_mag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_mag</span><span class="p">,</span>
                           <span class="s1">&#39;tri_filt_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_filt_names</span><span class="p">,</span>
                           <span class="s1">&#39;compute_local_density&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_local_density</span><span class="p">}</span>
                <span class="n">missing_tri_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                    <span class="p">[</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/trilegal_auf_simulation.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_download_tri</span> <span class="ow">or</span> <span class="n">missing_tri_check</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span>
                                   <span class="o">**</span><span class="p">{</span><span class="s1">&#39;tri_set_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_set_name</span><span class="p">,</span>
                                      <span class="s1">&#39;tri_filt_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_filt_num</span><span class="p">,</span>
                                      <span class="s1">&#39;auf_region_frame&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span><span class="p">})</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span>
                                   <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">,</span>
                                      <span class="s1">&#39;cmau_array&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">,</span> <span class="s1">&#39;wavs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_wavs</span><span class="p">,</span>
                                      <span class="s1">&#39;z_maxs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_zmax</span><span class="p">,</span> <span class="s1">&#39;nzs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_nzs</span><span class="p">,</span>
                                      <span class="s1">&#39;ab_offsets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_aboffsets</span><span class="p">,</span>
                                      <span class="s1">&#39;filter_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_filternames</span><span class="p">,</span>
                                      <span class="s1">&#39;al_avs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_al_avs</span><span class="p">,</span> <span class="s1">&#39;alpha0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span><span class="p">,</span>
                                      <span class="s1">&#39;alpha1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span><span class="p">,</span>
                                      <span class="s1">&#39;alpha_weight&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">})</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_download_tri</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">)):</span>
                        <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ax_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">{}</span><span class="s1">/trilegal_auf_simulation.dat </span><span class="si">{}</span><span class="s1">/..&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">ax_folder</span><span class="p">,</span> <span class="n">ax_folder</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax_folder</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">{}</span><span class="s1">/../trilegal_auf_simulation.dat </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">ax_folder</span><span class="p">,</span> <span class="n">ax_folder</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_local_density</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;density_radius&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dens_dist</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">))</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">perturb_auf_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">mem_chunk_num</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading empirical perturbation AUFs for catalogue &quot;a&quot;...&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">b_expected_files</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">files_per_auf_sim</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">))</span>
        <span class="n">b_file_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">)])</span>
        <span class="n">b_correct_file_number</span> <span class="o">=</span> <span class="n">b_expected_files</span> <span class="o">==</span> <span class="n">b_file_number</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_auf</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">b_correct_file_number</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">calc_j0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b_correct_file_number</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_auf</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Incorrect number of files in catalogue &quot;b&quot; perturbation &#39;</span>
                              <span class="s1">&#39;AUF simulation folder. Deleting all files and re-running &#39;</span>
                              <span class="s1">&#39;cross-match process.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_cf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_source</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;psf_fwhms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_psf_fwhms</span><span class="p">,</span> <span class="s1">&#39;tri_download_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_download_tri</span><span class="p">,</span>
                           <span class="s1">&#39;delta_mag_cuts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span><span class="p">,</span> <span class="s1">&#39;num_trials&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">,</span>
                           <span class="s1">&#39;j0s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="p">,</span> <span class="s1">&#39;density_mags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_dens_mags</span><span class="p">,</span>
                           <span class="s1">&#39;dm_max&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm_max</span><span class="p">,</span> <span class="s1">&#39;d_mag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_mag</span><span class="p">,</span>
                           <span class="s1">&#39;tri_filt_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_filt_names</span><span class="p">,</span>
                           <span class="s1">&#39;compute_local_density&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_local_density</span><span class="p">}</span>
                <span class="n">missing_tri_check</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                    <span class="p">[</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/trilegal_auf_simulation.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_download_tri</span> <span class="ow">or</span> <span class="n">missing_tri_check</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span>
                                   <span class="o">**</span><span class="p">{</span><span class="s1">&#39;tri_set_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_set_name</span><span class="p">,</span>
                                      <span class="s1">&#39;tri_filt_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_filt_num</span><span class="p">,</span>
                                      <span class="s1">&#39;auf_region_frame&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span><span class="p">})</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span>
                                   <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span><span class="p">,</span>
                                      <span class="s1">&#39;cmau_array&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">,</span> <span class="s1">&#39;wavs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_wavs</span><span class="p">,</span>
                                      <span class="s1">&#39;z_maxs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_zmax</span><span class="p">,</span> <span class="s1">&#39;nzs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_nzs</span><span class="p">,</span>
                                      <span class="s1">&#39;ab_offsets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_aboffsets</span><span class="p">,</span>
                                      <span class="s1">&#39;filter_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_filternames</span><span class="p">,</span>
                                      <span class="s1">&#39;al_avs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_al_avs</span><span class="p">,</span> <span class="s1">&#39;alpha0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span><span class="p">,</span>
                                      <span class="s1">&#39;alpha1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span><span class="p">,</span>
                                      <span class="s1">&#39;alpha_weight&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">})</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_download_tri</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">)):</span>
                        <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">ax_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">{}</span><span class="s1">/trilegal_auf_simulation.dat </span><span class="si">{}</span><span class="s1">/..&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">ax_folder</span><span class="p">,</span> <span class="n">ax_folder</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax_folder</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">{}</span><span class="s1">/../trilegal_auf_simulation.dat </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                  <span class="n">ax_folder</span><span class="p">,</span> <span class="n">ax_folder</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_local_density</span><span class="p">:</span>
                    <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;density_radius&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_dens_dist</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf </span><span class="si">{}</span><span class="s2">/*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">))</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">perturb_auf_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">mem_chunk_num</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading empirical perturbation AUFs for catalogue &quot;b&quot;...&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="CrossMatch.group_sources"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.group_sources">[docs]</a>    <span class="k">def</span> <span class="nf">group_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_per_grouping</span><span class="p">,</span> <span class="n">group_func</span><span class="o">=</span><span class="n">make_island_groupings</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to handle the creation of catalogue &quot;islands&quot; and potential</span>
<span class="sd">        astrometrically related sources across the two catalogues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files_per_grouping : integer</span>
<span class="sd">            The number of output files from each catalogue, made during the</span>
<span class="sd">            island and overlap creation process.</span>
<span class="sd">        group_func : callable, optional</span>
<span class="sd">            ``group_func`` should create the various island- and overlap-related</span>
<span class="sd">            files by which objects across the two catalogues are assigned as</span>
<span class="sd">            potentially counterparts to one another.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Each catalogue should expect 7 files in &quot;group/&quot; or &quot;reject/&quot;: island</span>
        <span class="c1"># lengths, indices into the opposite catalogue for each source, the</span>
        <span class="c1"># indices of sources in this catalogue in each island, the number of</span>
        <span class="c1"># opposing catalogue overlaps for each source, &quot;field&quot; and &quot;bright&quot; error</span>
        <span class="c1"># circle lengths, and the list of any &quot;rejected&quot; source indices. However,</span>
        <span class="c1"># there may be no &quot;reject&quot; arrays, so we might expect two fewer files.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="s1">&#39;reject_a&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/reject&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))])</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="s1">&#39;reject_b&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/reject&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))])):</span>
            <span class="n">expected_files</span> <span class="o">=</span> <span class="p">(</span><span class="n">files_per_grouping</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expected_files</span> <span class="o">=</span> <span class="n">files_per_grouping</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">file_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/group&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/reject&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))])</span>
        <span class="n">correct_file_number</span> <span class="o">=</span> <span class="n">expected_files</span> <span class="o">==</span> <span class="n">file_number</span>

        <span class="c1"># TODO: generalise as user input</span>
        <span class="n">n_pool</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="c1"># First check whether we actually need to dip into the group sources</span>
        <span class="c1"># routine or not.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_group</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">correct_file_number</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span> <span class="o">=</span> <span class="n">gsf</span><span class="o">.</span><span class="n">calc_j1s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Only worry about the warning if we didn&#39;t choose to run the grouping</span>
            <span class="c1"># but hit incorrect file numbers.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">correct_file_number</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_group</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Incorrect number of grouping files. Deleting all &#39;</span>
                              <span class="s1">&#39;grouping files and re-running cross-match process.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_cf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_source</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">{}</span><span class="s1">/group/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">{}</span><span class="s1">/reject/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
            <span class="n">group_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_corr_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">mem_chunk_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_phot_like</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_phot_priors</span><span class="p">,</span> <span class="n">n_pool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading catalogue islands and overlaps...&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="CrossMatch.calculate_phot_like"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.calculate_phot_like">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_phot_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_per_phot</span><span class="p">,</span> <span class="n">phot_like_func</span><span class="o">=</span><span class="n">compute_photometric_likelihoods</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the photometric likelihood information used in the cross-match</span>
<span class="sd">        process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files_per_phot : integer</span>
<span class="sd">            The number of files created during the cross-match process for each</span>
<span class="sd">            individual photometric sky position pointing.</span>
<span class="sd">        phot_like_func : callable, optional</span>
<span class="sd">            The function that calls the overall computation of the counterpart</span>
<span class="sd">            and &quot;field&quot; star photometric likelihood-related information.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Saved files per catalogue: magnitude bins and bin array lengths, &quot;field&quot;</span>
        <span class="c1"># source priors/likelihoods, and the sky slice index of each source.</span>
        <span class="c1"># Additionally, &quot;counterpart&quot; prior/likelihood functions are saved, for</span>
        <span class="c1"># 2 + 2 * 5 files total.</span>
        <span class="n">file_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))])</span>
        <span class="n">expected_file_number</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">files_per_phot</span>

        <span class="n">correct_file_number</span> <span class="o">=</span> <span class="n">expected_file_number</span> <span class="o">==</span> <span class="n">file_number</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_cf</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">correct_file_number</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">correct_file_number</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_cf</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Incorrect number of photometric likelihood files. Deleting all &#39;</span>
                              <span class="s1">&#39;c/f files and re-running calculations.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_source</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -r </span><span class="si">{}</span><span class="s1">/phot_like/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cf_areas</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_phot_priors</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_phot_like</span><span class="p">:</span>
                <span class="n">bright_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">field_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bright_frac</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">field_frac</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">phot_like_func</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_chunk_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cf_areas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_phot_like</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_phot_priors</span><span class="p">,</span> <span class="n">bright_frac</span><span class="p">,</span>
                <span class="n">field_frac</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading photometric priors and likelihoods...&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_calculate_cf_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convenience function to calculate the area around each</span>
<span class="sd">        ``cross_match_extent`` sky coordinate where it is defined as having the</span>
<span class="sd">        smallest on-sky separation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating photometric region areas...&quot;</span><span class="p">)</span>
        <span class="n">dlon</span><span class="p">,</span> <span class="n">dlat</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span>
        <span class="n">test_lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlon</span><span class="p">)</span>
        <span class="n">test_lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlat</span><span class="p">)</span>

        <span class="n">test_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">test_lons</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_lats</span><span class="p">])</span>

        <span class="n">inds</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">find_nearest_point</span><span class="p">(</span><span class="n">test_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">cf_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Unit area of a sphere is cos(theta) dtheta dphi if theta goes from -90</span>
        <span class="c1"># to +90 degrees (sin(theta) for 0 to 180 degrees). Note, however, that</span>
        <span class="c1"># dtheta and dphi have to be in radians, so we have to convert the entire</span>
        <span class="c1"># thing from degrees and re-convert at the end. Hence:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">test_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span> <span class="o">=</span> <span class="n">dlat</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">dlon</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="c1"># Remember to convert back to square degrees:</span>
            <span class="n">cf_areas</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">dphi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cf_areas</span> <span class="o">=</span> <span class="n">cf_areas</span>

        <span class="k">return</span>

<div class="viewcode-block" id="CrossMatch.pair_sources"><a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.pair_sources">[docs]</a>    <span class="k">def</span> <span class="nf">pair_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files_per_pairing</span><span class="p">,</span> <span class="n">count_pair_func</span><span class="o">=</span><span class="n">source_pairing</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Assign sources in the two catalogues as either counterparts to one another</span>
<span class="sd">        or singly detected &quot;field&quot; sources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        files_per_pairing : integer</span>
<span class="sd">            The number of saved files expected in the pairing folder.</span>
<span class="sd">        count_pair_func : callable, optional</span>
<span class="sd">            The function that calls the counterpart determination routine.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">file_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))])</span>
        <span class="c1"># No complicated maths here, since all files are common and in a single</span>
        <span class="c1"># folder common to the pairing process.</span>
        <span class="n">expected_file_number</span> <span class="o">=</span> <span class="n">files_per_pairing</span>

        <span class="n">correct_file_number</span> <span class="o">=</span> <span class="n">expected_file_number</span> <span class="o">==</span> <span class="n">file_number</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_source</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">correct_file_number</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">correct_file_number</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_source</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Incorrect number of counterpart pairing files. Deleting all &#39;</span>
                              <span class="s1">&#39;files and re-running calculations.&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -r </span><span class="si">{}</span><span class="s1">/pairing/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
            <span class="n">count_pair_func</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_chunk_num</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading pre-assigned counterparts...&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.matching</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Tom J Wilson.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>